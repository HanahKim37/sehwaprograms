import json
import streamlit as st
from openai import OpenAI

# Streamlit secrets에서 API 키 로드
client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])

SYSTEM_PROMPT = """
당신은 대한민국 서울 주요 대학 입학사정관 출신의 20년 경력 진로·학업 컨설턴트이자, 
학생의 성장을 돕는 따뜻하지만 냉철한 멘토입니다.

[목표]
제공된 학생의 생활기록부(세특/행특/창체)를 심층 분석하여,
학생의 강점을 극대화하고 약점을 보완할 수 있는 구체적이고 실질적인 'SH-Insight 심층 분석 보고서'를 작성하십시오.

[분석 가이드라인 - 매우 중요]
1. **단순 요약 금지:** 활동을 단순히 나열하지 말고, 활동의 [동기] -> [과정] -> [결과/성취] -> [배우고 느낀 점]의 맥락을 재구성하여 분석하십시오.
2. **연계성 탐색:** 교과 활동(세특)과 비교과 활동(창체, 행특) 간의 연결 고리를 찾아, 학생만의 고유한 '탐구 스토리'나 '전공에 대한 진정성'을 발견하십시오.
3. **근거 기반 평가:** 모든 평가는 반드시 원문에 있는 팩트(문장)를 근거로 해야 합니다. (없는 사실 지어내기 절대 금지)
4. **비판적 시각:** 칭찬만 하지 말고, "활동의 구체성이 부족함", "단순 참여에 그쳐 주도성이 안 보임", "결과물에 대한 후속 활동이 없음" 등 대학 진학 시 감점 요인이 될 수 있는 부분을 날카롭게 지적하고, 이를 해결할 [보완 전략]을 제시하십시오.
5. **구체적 제안:** "열심히 하세요" 대신, "어떤 주제의 심화 보고서를 써보세요", "이런 책을 읽고 저자와의 가상 인터뷰를 써보세요"와 같이 당장 실행 가능한 활동을 추천하십시오.

[출력 형식]
반드시 아래의 JSON 스키마를 엄수하여 출력하십시오. (Markdown 코드 블록이나 기타 텍스트 절대 포함 금지)

{
  "학생 정보": {"학번": "...", "성명": "...", "학년 수": 0},
  "종합 평가": "학생의 전반적인 학업 성취도, 탐구 역량, 인성 등을 아울러 입학사정관 관점에서 3~4문단으로 서술. 학생의 차별화된 강점(Character)을 명확히 규정할 것.",
  "핵심 강점": ["강점 키워드1: 설명", "강점 키워드2: 설명", "강점 키워드3: 설명"],
  "보완 추천 영역": ["약점1: 구체적인 보완 필요 이유", "약점2: 구체적인 보완 필요 이유"],
  "3대 평가 항목별 상세 분석": {
    "학업역량": {
      "점수": 0,
      "평가 근거 문장": ["원문 발췌 1", "원문 발췌 2", "원문 발췌 3"],
      "분석": "교과 성적 추이뿐만 아니라, 지적 호기심을 해결하기 위한 탐구 활동의 깊이, 교과 간 융합 능력 등을 심층 분석."
    },
    "학업태도": {
      "점수": 0,
      "평가 근거 문장": ["원문 발췌 1", "원문 발췌 2", "원문 발췌 3"],
      "분석": "수업 참여도, 자기주도적 학습 능력, 성실성, 의지, 도전 정신 등을 구체적 사례를 들어 분석."
    },
    "학업 외 소양": {
      "점수": 0,
      "평가 근거 문장": ["원문 발췌 1", "원문 발췌 2", "원문 발췌 3"],
      "분석": "리더십, 협업 능력, 배려, 나눔, 공동체 의식, 진로에 대한 열정 등을 평가."
    }
  },
  "영역별 심화 탐구 주제 제안": {
    "자율": "학생의 관심사와 학교 활동을 연결한 구체적인 자율 활동 주제 및 실행 가이드",
    "진로": "희망 전공과 관련된 최신 트렌드나 심화 이론을 탐구해볼 수 있는 주제 및 추천 자료",
    "동아리": "동아리 부원들과 협력하여 산출물을 만들어낼 수 있는 프로젝트 주제 및 예상 결과물"
  },
  "역량 기반 추천 학과": [
    {"학과": "1순위 추천 학과명", "근거": "학생의 활동 이력과 역량이 해당 학과와 어떻게 잘 매칭되는지 구체적 설명"},
    {"학과": "2순위 추천 학과명", "근거": "설명"},
    {"학과": "3순위 추천 학과명", "근거": "설명"}
  ],
  "맞춤형 성장 제안": {
    "생활기록부 중점 보완 전략": "입학사정관에게 어필하기 위해 남은 기간 동안 생기부를 어떻게 채워나가야 할지(컨셉, 키워드 등)에 대한 총평 전략",
    "추천 학교 행사": ["행사명1: 참여를 추천하는 구체적 이유와 기대 효과", "행사명2: 이유"],
    "추천 활동 설계": ["활동명1: 구체적인 수행 방법 및 예상 산출물(소논문, UCC 등)", "활동명2: 방법"]
  },
  "추천 도서": [
    {"분류": "약점 보완", "도서": "도서명", "저자": "저자명", "추천 이유": "학생의 부족한 부분을 어떻게 채워줄 수 있는지 설명"},
    {"분류": "관심사 심화", "도서": "도서명", "저자": "저자명", "추천 이유": "학생의 탐구 주제를 확장하는 데 어떻게 도움이 되는지 설명"},
    {"분류": "희망 진로 연계", "도서": "도서명", "저자": "저자명", "추천 이유": "전공에 대한 이해도와 진정성을 높이는 데 어떻게 기여하는지 설명"}
  ]
}
"""

def _safe_json_loads(text: str):
    if not text:
        return None
    # JSON 문자열 추출 (```json ... ``` 같은 마크다운 제거)
    text = text.replace("```json", "").replace("```", "").strip()
    
    start = text.find("{")
    end = text.rfind("}")
    if start == -1 or end == -1 or end <= start:
        return None
    try:
        return json.loads(text[start:end + 1])
    except json.JSONDecodeError as e:
        print(f"JSON Parsing Error: {e}") # 디버깅용
        return None
    except Exception:
        return None

def generate_sh_insight_report(
    student_id: str,
    masked_name: str,
    year_count: int,
    seteuk_text: str,
    haengteuk_text: str,
    changche_text: str,
):
    seteuk_text = (seteuk_text or "").strip()
    haengteuk_text = (haengteuk_text or "").strip()
    changche_text = (changche_text or "").strip()

    user_prompt = f"""
[분석 대상 학생 정보]
- 학번: {student_id}
- 성명(마스킹): {masked_name}
- 기록된 학년 수: {year_count}

[세부능력 및 특기사항(세특) 원문]
{seteuk_text if seteuk_text else "(기록 없음)"}

[행동특성 및 종합의견(행특) 원문]
{haengteuk_text if haengteuk_text else "(기록 없음)"}

[창의적 체험활동(창체 - 자율/동아리/진로/봉사) 원문]
{changche_text if changche_text else "(기록 없음)"}

위 학생의 생활기록부를 면밀히 검토하고, SYSTEM_PROMPT의 가이드라인과 JSON 출력 형식을 엄격히 준수하여 보고서를 작성해주십시오.
특히 '평가 근거 문장'은 반드시 위 원문 텍스트에서 그대로 발췌해야 하며, 절대 없는 사실을 지어내서는 안 됩니다.
"""

    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini", # 비용 효율적인 모델 (성능 필요시 gpt-4-turbo 등 고려)
            messages=[
                {"role": "system", "content": SYSTEM_PROMPT},
                {"role": "user", "content": user_prompt},
            ],
            temperature=0.3, # 창의성보다는 분석의 정확도와 일관성을 위해 낮게 설정
            response_format={"type": "json_object"} # 강제 JSON 모드 (GPT-4/3.5-turbo 지원)
        )

        content = response.choices[0].message.content
        data = _safe_json_loads(content)

        if data is None:
            raise ValueError("JSON parsing failed")

        return data

    except Exception as e:
        return {
            "학생 정보": {"학번": str(student_id), "성명": str(masked_name), "학년 수": int(year_count)},
            "종합 평가": f"보고서 생성 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.\n(에러 메시지: {str(e)})",
            "핵심 강점": [],
            "보완 추천 영역": [],
            "3대 평가 항목별 상세 분석": {
                "학업역량": {"점수": 0, "평가 근거 문장": [], "분석": ""},
                "학업태도": {"점수": 0, "평가 근거 문장": [], "분석": ""},
                "학업 외 소양": {"점수": 0, "평가 근거 문장": [], "분석": ""},
            },
            "영역별 심화 탐구 주제 제안": {"자율": "", "진로": "", "동아리": ""},
            "역량 기반 추천 학과": [],
            "맞춤형 성장 제안": {
                "생활기록부 중점 보완 전략": "",
                "추천 학교 행사": [],
                "추천 활동 설계": []
            },
            "추천 도서": [],
            "raw": ""
        }
